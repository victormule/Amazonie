<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quai Branly ‚Äì Mem√≥ria & Alma</title>

    <!-- ================== ESTILOS ================== -->
    <style>
      :root {
        --bg: #111;
        --text: #f5f5f5;
        --accent: #f59e0b;
        --border: #444;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 2rem 1rem;
        font-family: system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      h1 {
        margin: 0 0 3rem;
        font-size: 2.5rem;
        letter-spacing: .05em;
        text-align: center;
      }
      .artefact { display: flex; align-items: flex-start; gap: 1.5rem; margin-bottom: 3rem; }
      .artefact img { width: 45%; height: auto; object-fit: contain; box-shadow: 0 4px 16px rgba(0,0,0,.6); }
      .panel { flex: 1; border: 1px solid var(--border); padding: 1rem; display: flex; flex-direction: column; max-height: 600px; }
      .panel-upper { flex: 1 1 auto; overflow-y: auto; margin-bottom: 1rem; padding-right: .5rem; }
      .note { background: rgba(255,255,255,.05); padding: .5rem .75rem; margin: 0 0 .5rem; border-radius: 4px; font-size: .9rem; }
      .panel-lower { border-top: 1px solid var(--border); padding-top: 1rem; }
      textarea, input[type="text"] { width: 100%; background:#222; color:var(--text); border:1px solid var(--border); border-radius:4px; padding:.5rem; margin-bottom:.5rem; }
      textarea { min-height:60px; resize:vertical; }
      button { background:var(--accent); border:none; color:#000; padding:.5rem 1rem; border-radius:4px; cursor:pointer; }
      button:hover { filter:brightness(1.1); }
      .preview { display:flex; align-items:center; gap:.5rem; margin-top:.5rem; }
      .preview button { padding:0 .4rem; }
      .load-more-btn { display: block; margin: 2rem auto; }
      .load-more-comments { display: block; width: 100%; margin-top: 1rem; background: rgba(255,255,255,.1); color: var(--text); }
      .play-audio { background: rgba(255,255,255,.1); color: var(--text); padding: .3rem .5rem; font-size: .8rem; }
      @media (max-width:768px){ .artefact{flex-direction:column;} .artefact img{width:100%;} }
    </style>
  </head>
  <body>
    <h1>Quai Branly ‚Äì <span style="color:var(--accent)">Mem√≥ria & Alma</span></h1>
    <div id="gallery"></div>

    <script>
      /* ===== CONFIG ===== */
      // Remplace pelo URL do seu projeto Supabase (sem barra final)
      const SUPABASE_URL = "https://ynnrudehlmwtnimrukhm.supabase.co";

      const images = [
        { src: "assets/image1.png", alt: "Peitoral de penas e contas" },
        { src: "assets/image2.png", alt: "Cinto tran√ßado com penas" },
        { src: "assets/image3.png", alt: "Coroa cerimonial" },
        { src: "assets/image4.png", alt: "Cesto ritual" },
        { src: "assets/image5.png", alt: "Pente frontal" },
        { src: "assets/image6.png", alt: "Brincos de penas" },
      ];

      const gallery = document.getElementById('gallery');
      const messageCache = {}; // Cache pour les messages

      /* === helpers === */
      const blobToBase64 = blob => new Promise(r => {
        const fr = new FileReader();
        fr.onload = () => r(fr.result.split(',')[1]);
        fr.readAsDataURL(blob);
      });

      function renderMessages(messages, container, clearContainer = true) {
        if (clearContainer) container.innerHTML = '';
        
        if (!messages.length && clearContainer) {
          container.innerHTML = '<p class="note">Nenhum coment√°rio por enquanto‚Ä¶</p>';
          return;
        }
        
        messages.forEach(m => {
          const div = document.createElement('div');
          div.className = 'note';
          div.innerHTML = `<strong>${m.author}</strong> ‚Äì <em>${new Date(m.created_at).toLocaleString('pt-BR')}</em><br>`;
          if (m.comment) {
            div.innerHTML += `<p style="margin:0 0 .5rem">${m.comment}</p>`;
          }
          if (m.audio_path) {
            const audioContainer = document.createElement('div');
            audioContainer.className = 'audio-lazy';
            audioContainer.innerHTML = `<button class="play-audio">‚ñ∂Ô∏è Ouvir √°udio</button>`;
            audioContainer.dataset.src = `${SUPABASE_URL}/storage/v1/object/public/recordings/${m.audio_path}`;
            
            audioContainer.querySelector('button').addEventListener('click', function() {
              const audio = document.createElement('audio');
              audio.controls = true;
              audio.src = audioContainer.dataset.src;
              this.replaceWith(audio);
              audio.play();
            });
            
            div.appendChild(audioContainer);
          }
          container.appendChild(div);
        });
      }

      async function loadMessages(artefactId, upper, page = 0, limit = 10) {
        const cacheKey = `${artefactId}-${page}`;
        
        if (messageCache[cacheKey]) {
          renderMessages(messageCache[cacheKey], upper, page === 0);
          return messageCache[cacheKey].length === limit;
        }
        
        const res = await fetch(`/.netlify/functions/get-messages?artefact=${encodeURIComponent(artefactId)}&page=${page}&limit=${limit}`);
        const data = await res.json();
        
        messageCache[cacheKey] = data; // Sauvegarder dans le cache
        renderMessages(data, upper, page === 0);
        
        return data.length === limit;
      }

      // Fonction pour rendre un artefact
      function renderArtefact({ src, alt }) {
        const artefactId = src.split('/').pop(); // ex: image1.png

        /* --- structure DOM --- */
        const row = document.createElement('div'); 
        row.className = 'artefact';
        
        // Correction du lazy loading des images
        const img = document.createElement('img');
        img.alt = alt;
        img.src = src; // Chargement direct de l'image pour r√©soudre l'erreur 404
        img.loading = 'lazy'; // Utilisation de l'attribut loading natif pour le lazy loading
        
        row.appendChild(img);
        const panel = document.createElement('div'); 
        panel.className='panel';
        const upper = document.createElement('div'); 
        upper.className='panel-upper'; 
        panel.appendChild(upper);
        
        const lower = document.createElement('div'); 
        lower.className='panel-lower';
        lower.innerHTML = `
          <input type="text" placeholder="Seu nome (opcional)" />
          <textarea placeholder="Adicionar um coment√°rio‚Ä¶"></textarea>
          <button data-publish>Publicar</button>
          <button style="margin-left:.5rem" data-audio>üéôÔ∏è Gravar</button>
          <div class="preview" data-preview></div>`;
        
        panel.appendChild(lower); 
        row.appendChild(panel); 
        gallery.appendChild(row);

        // Bouton pour charger plus de commentaires
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.textContent = 'Carregar mais coment√°rios';
        loadMoreBtn.className = 'load-more-comments';
        loadMoreBtn.style.display = 'none';
        upper.after(loadMoreBtn);

        /* --- r√©f√©rences --- */
        const nameInput = lower.querySelector('input');
        const textarea  = lower.querySelector('textarea');
        const publishBtn= lower.querySelector('[data-publish]');
        const audioBtn  = lower.querySelector('[data-audio]');
        const preview   = lower.querySelector('[data-preview]');

        let tempBlob = null;
        let tempURL  = null;
        let recorder = null, chunks=[];
        let currentPage = 0;

        function resetPreview(){
          if (tempURL){ URL.revokeObjectURL(tempURL); tempURL=null; }
          tempBlob=null; preview.innerHTML='';
        }
        function renderPreview(){
          preview.innerHTML=''; if(!tempURL) return;
          const audio=document.createElement('audio'); audio.controls=true; audio.src=tempURL;
          const del=document.createElement('button'); del.textContent='üóëÔ∏è'; del.title='Excluir a grava√ß√£o';
          del.onclick=resetPreview; preview.append(audio,del);
        }

        /* === LOAD EXISTING === */
        loadMessages(artefactId, upper).then(hasMore => {
          if (hasMore) loadMoreBtn.style.display = 'block';
        });

        loadMoreBtn.addEventListener('click', async () => {
          currentPage++;
          const hasMore = await loadMessages(artefactId, upper, currentPage);
          if (!hasMore) loadMoreBtn.style.display = 'none';
        });

        /* === RECORD === */
        audioBtn.addEventListener('click', async () => {
          if (!recorder || recorder.state==='inactive'){
            try{
              const stream = await navigator.mediaDevices.getUserMedia({audio:true});
              recorder = new MediaRecorder(stream); chunks=[];
              recorder.ondataavailable=e=>chunks.push(e.data);
              recorder.onstop=()=>{
                tempBlob=new Blob(chunks,{type:'audio/webm'});
                tempURL=URL.createObjectURL(tempBlob);
                renderPreview(); audioBtn.textContent='üéôÔ∏è Gravar';
              };
              recorder.start(); audioBtn.textContent='‚èπÔ∏è Parar';
            }catch(err){ alert('N√£o foi poss√≠vel acessar o microfone'); }
          }else if(recorder.state==='recording'){ recorder.stop(); }
        });

        /* === PUBLISH === */
        publishBtn.addEventListener('click', async () => {
          const comment = textarea.value.trim();
          if (!comment && !tempBlob) return;
          publishBtn.disabled=true;
          const payload = {
            artefact_id: artefactId,
            author     : nameInput.value.trim() || 'An√¥nimo',
            comment,
            audioBase64: tempBlob ? await blobToBase64(tempBlob) : null
          };
          const res = await fetch('/.netlify/functions/add-message', {
            method:'POST', body: JSON.stringify(payload)
          });
          if((await res.text())==='ok'){
            textarea.value=''; nameInput.value=''; resetPreview();
            
            // Vider le cache pour cet artefact
            Object.keys(messageCache).forEach(key => {
              if (key.startsWith(artefactId)) delete messageCache[key];
            });
            
            currentPage = 0;
            loadMessages(artefactId, upper).then(hasMore => {
              loadMoreBtn.style.display = hasMore ? 'block' : 'none';
            });
          }else{ alert('Erro ao publicar'); }
          publishBtn.disabled=false;
        });
      }

      // Charger les artefacts de mani√®re progressive
      const displayedImages = images.slice(0, 3);
      let currentIndex = 3;

      function loadMoreArtefacts() {
        const nextImages = images.slice(currentIndex, currentIndex + 3);
        currentIndex += 3;
        
        nextImages.forEach(renderArtefact);
        
        if (currentIndex >= images.length) {
          loadMoreArtefactsBtn.style.display = 'none';
        }
      }

      // Ajouter un bouton pour charger plus d'artefacts
      const loadMoreArtefactsBtn = document.createElement('button');
      loadMoreArtefactsBtn.textContent = 'Carregar mais artefatos';
      loadMoreArtefactsBtn.className = 'load-more-btn';
      loadMoreArtefactsBtn.addEventListener('click', loadMoreArtefacts);

      // Rendre les 3 premiers artefacts
      displayedImages.forEach(renderArtefact);
      
      // Ajouter le bouton si n√©cessaire
      if (images.length > 3) {
        gallery.after(loadMoreArtefactsBtn);
      }
    </script>
  </body>
</html>
