<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quai Branly ‚Äì Mem√≥ria & Alma</title>

    <!-- ================== ESTILOS ================== -->
    <style>
      :root {
        --bg: #111;
        --text: #f5f5f5;
        --accent: #f59e0b;
        --border: #444;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 2rem 1rem;
        font-family: system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      h1 {
        margin: 0 0 3rem;
        font-size: 2.5rem;
        letter-spacing: .05em;
        text-align: center;
      }
      .artefact { display: flex; align-items: flex-start; gap: 1.5rem; margin-bottom: 3rem; }
      .artefact img { width: 45%; height: auto; object-fit: contain; box-shadow: 0 4px 16px rgba(0,0,0,.6); }
      .panel { flex: 1; border: 1px solid var(--border); padding: 1rem; display: flex; flex-direction: column; max-height: 600px; }
      .panel-upper { flex: 1 1 auto; overflow-y: auto; margin-bottom: 1rem; padding-right: .5rem; }
      .note { background: rgba(255,255,255,.05); padding: .5rem .75rem; margin: 0 0 .5rem; border-radius: 4px; font-size: .9rem; }
      .panel-lower { border-top: 1px solid var(--border); padding-top: 1rem; }
      textarea, input[type="text"] { width: 100%; background:#222; color:var(--text); border:1px solid var(--border); border-radius:4px; padding:.5rem; margin-bottom:.5rem; }
      textarea { min-height:60px; resize:vertical; }
      button { background:var(--accent); border:none; color:#000; padding:.5rem 1rem; border-radius:4px; cursor:pointer; }
      button:hover { filter:brightness(1.1); }
      .preview { display:flex; align-items:center; gap:.5rem; margin-top:.5rem; }
      .preview button { padding:0 .4rem; }
      .load-more-comments { display: block; width: 100%; margin-top: 1rem; background: rgba(255,255,255,.1); color: var(--text); }
      .play-audio { background: rgba(255,255,255,.1); color: var(--text); padding: .3rem .5rem; font-size: .8rem; }
      #loading-indicator { text-align: center; padding: 1rem; color: var(--accent); display: none; }
      
      .privacy-link {
        text-align: center;
        margin-bottom: 1rem;
      }
      .privacy-link a {
        color: var(--text);
        text-decoration: none;
        border-bottom: 1px dotted var(--border);
        font-size: 0.9rem;
      }
      .privacy-link a:hover {
        color: var(--accent);
        border-color: var(--accent);
      }
      
      .delete-btn {
        background: transparent;
        color: #ff4d4d;
        border: 1px solid #ff4d4d;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        margin-top: 0.5rem;
        cursor: pointer;
        border-radius: 3px;
      }
      .delete-btn:hover {
        background: rgba(255, 77, 77, 0.1);
      }
      
      @media (max-width:768px){ .artefact{flex-direction:column;} .artefact img{width:100%;} }
    </style>
  </head>
  <body>
    <h1>Quai Branly ‚Äì <span style="color:var(--accent)">Mem√≥ria & Alma</span></h1>
    <div class="privacy-link"><a href="privacy.html">Pol√≠tica de Privacidade</a></div>
    <div><br></div>
    <div id="gallery"></div>
    <div id="loading-indicator">Carregando mais artefatos...</div>

    <script>
      /* ===== CONFIG ===== */
      // Remplace pelo URL do seu projeto Supabase (sem barra final)
      const SUPABASE_URL = "https://ynnrudehlmwtnimrukhm.supabase.co";
      const MAX_AUDIO_BYTES = 5 * 1024 * 1024; 

      const images = [
        { src: "assets/image1.png", alt: "Peitoral de penas e contas" },
        { src: "assets/image2.png", alt: "Cinto tran√ßado com penas" },
        { src: "assets/image3.png", alt: "Coroa cerimonial" },
        { src: "assets/image4.png", alt: "Cesto ritual" },
        { src: "assets/image5.png", alt: "Pente frontal" },
        { src: "assets/image6.png", alt: "Brincos de penas" },
        { src: "assets/image7.png", alt: "Coroa cerimonial" },
        { src: "assets/image8.png", alt: "Cesto ritual" },
        { src: "assets/image9.png", alt: "Pente frontal" },
        { src: "assets/image10.png", alt: "Brincos de penas" },
      ];

      const gallery = document.getElementById('gallery');
      const loadingIndicator = document.getElementById('loading-indicator');
      const messageCache = {}; // Cache pour les messages
      
      // Variables pour le scroll infini
      let currentIndex = 0;
      let isLoading = false;

      /* === helpers === */
      const blobToBase64 = blob => new Promise(r => {
        const fr = new FileReader();
        fr.onload = () => r(fr.result.split(',')[1]);
        fr.readAsDataURL(blob);
      });
      
      function generateSecretKey() {
        return Array.from(crypto.getRandomValues(new Uint8Array(16)))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("");
      }
      
      function formatTime(sec) {
  const m = Math.floor(sec / 60).toString().padStart(2,'0');
  const s = (sec % 60).toString().padStart(2,'0');
  return `${m}:${s}`;
}
      async function deleteMessage(messageId, secretKey, artefactId, upperPanel, loadMoreBtn) {
        if (!confirm('Tem certeza que deseja excluir este coment√°rio?')) return;
        
        try {
          const res = await fetch('/.netlify/functions/delete-message', {
            method: 'POST',
            body: JSON.stringify({ id: messageId, delete_token: secretKey })
          });
          
          const result = await res.text();
          if (result === 'ok') {
            // Suppression r√©ussie, mettre √† jour localStorage
            const userMessages = JSON.parse(localStorage.getItem('userMessages') || '{}');
            delete userMessages[messageId];
            localStorage.setItem('userMessages', JSON.stringify(userMessages));
            
            // Vider le cache pour cet artefact
            Object.keys(messageCache).forEach(key => {
              if (key.startsWith(artefactId)) delete messageCache[key];
            });
            
            // Recharger les messages
            const currentPage = 0;
            loadMessages(artefactId, upperPanel).then(hasMore => {
              if (loadMoreBtn) loadMoreBtn.style.display = hasMore ? 'block' : 'none';
            });
          } else {
            alert('Erro ao excluir: chave inv√°lida ou mensagem n√£o encontrada');
          }
        } catch (err) {
          alert('Erro ao excluir: ' + err.message);
        }
      }

      function renderMessages(messages, container, artefactId, loadMoreBtn, clearContainer = true) {
        if (clearContainer) container.innerHTML = '';
        
        if (!messages.length && clearContainer) {
          container.innerHTML = '<p class="note">Nenhum coment√°rio por enquanto‚Ä¶</p>';
          return;
        }
        
        // R√©cup√©rer les cl√©s stock√©es dans localStorage
        const userMessages = JSON.parse(localStorage.getItem('userMessages') || '{}');
        
        messages.forEach(m => {
          const div = document.createElement('div');
          div.className = 'note';
          div.innerHTML = `<strong>${m.author}</strong> ‚Äì <em>${new Date(m.created_at).toLocaleString('pt-BR')}</em><br>`;
          
          if (m.comment) {
            div.innerHTML += `<p style="margin:0 0 .5rem">${m.comment}</p>`;
          }
          
          if (m.audio_path) {
            const audioContainer = document.createElement('div');
            audioContainer.className = 'audio-lazy';
            audioContainer.innerHTML = `<button class="play-audio">‚ñ∂Ô∏è Ouvir √°udio</button>`;
            audioContainer.dataset.src = `${SUPABASE_URL}/storage/v1/object/public/recordings/${m.audio_path}`;
            
            audioContainer.querySelector('button').addEventListener('click', function() {
              const audio = document.createElement('audio');
              audio.controls = true;
              audio.src = audioContainer.dataset.src;
              this.replaceWith(audio);
              audio.play();
            });
            
            div.appendChild(audioContainer);
          }
          
          // V√©rifier si ce message appartient √† l'utilisateur actuel
          if (userMessages[m.id]) {
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'üóëÔ∏è Excluir';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = () => deleteMessage(m.id, userMessages[m.id], artefactId, container, loadMoreBtn);
            div.appendChild(deleteBtn);
          }
          
          container.appendChild(div);
        });
      }

      async function loadMessages(artefactId, upper, page = 0, limit = 10) {
        const cacheKey = `${artefactId}-${page}`;
        
        if (messageCache[cacheKey]) {
          renderMessages(messageCache[cacheKey], upper, artefactId, null, page === 0);
          return messageCache[cacheKey].length === limit;
        }
        
        const res = await fetch(`/.netlify/functions/get-messages?artefact=${encodeURIComponent(artefactId)}&page=${page}&limit=${limit}`);
        const data = await res.json();
        
        messageCache[cacheKey] = data; // Sauvegarder dans le cache
        renderMessages(data, upper, artefactId, null, page === 0);
        
        return data.length === limit;
      }

      // Fonction pour rendre un artefact
      function renderArtefact({ src, alt }) {
        const artefactId = src.split('/').pop(); // ex: image1.png

        /* --- structure DOM --- */
        const row = document.createElement('div'); 
        row.className = 'artefact';
        
        const img = document.createElement('img');
        img.alt = alt;
        img.src = src;
        img.loading = 'lazy'; // Utilisation de l'attribut loading natif
        
        row.appendChild(img);
        const panel = document.createElement('div'); 
        panel.className='panel';
        const upper = document.createElement('div'); 
        upper.className='panel-upper'; 
        panel.appendChild(upper);
        
        const lower = document.createElement('div'); 
        lower.className='panel-lower';
lower.innerHTML = `
  <input type="text" placeholder="Seu nome (opcional)" />
  <textarea placeholder="Adicionar um coment√°rio‚Ä¶"></textarea>
  <button data-publish>Publicar</button>
  <button style="margin-left:.5rem" data-audio>üéôÔ∏è Gravar</button>
  <span class="rec-time" style="margin-left:.5rem;font-size:.8rem;color:#ccc"></span>
  <div class="preview" data-preview></div>
`;
        
        panel.appendChild(lower); 
        row.appendChild(panel); 
        gallery.appendChild(row);

        // Bouton pour charger plus de commentaires
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.textContent = 'Carregar mais coment√°rios';
        loadMoreBtn.className = 'load-more-comments';
        loadMoreBtn.style.display = 'none';
        upper.after(loadMoreBtn);

        /* --- r√©f√©rences --- */
        const nameInput = lower.querySelector('input');
        const textarea  = lower.querySelector('textarea');
        const publishBtn= lower.querySelector('[data-publish]');
        const audioBtn  = lower.querySelector('[data-audio]');
        const preview   = lower.querySelector('[data-preview]');

        const timerSpan = lower.querySelector('.rec-time');

        let startTime   = null;      // horodatage d√©but
        let timerId     = null;      // setInterval id
        
        let tempBlob = null;
        let tempURL  = null;
        let recorder = null, chunks=[];
        let currentPage = 0;

        function resetPreview(){
          if (tempURL){ URL.revokeObjectURL(tempURL); tempURL=null; }
          tempBlob=null; preview.innerHTML='';
        }
        function renderPreview(){
          preview.innerHTML=''; if(!tempURL) return;
          const audio=document.createElement('audio'); audio.controls=true; audio.src=tempURL;
          audio.addEventListener('loadedmetadata', () => {
  const dur = formatTime(Math.round(audio.duration));
  const label = document.createElement('span');
  label.textContent = ` ${dur}`;
  label.style.fontSize = '.8rem';
  label.style.color = '#aaa';
  preview.appendChild(label);
});
          const del=document.createElement('button'); del.textContent='üóëÔ∏è'; del.title='Excluir a grava√ß√£o';
          del.onclick=resetPreview; preview.append(audio,del);
        }

        /* === LOAD EXISTING === */
        loadMessages(artefactId, upper).then(hasMore => {
          if (hasMore) loadMoreBtn.style.display = 'block';
        });

        loadMoreBtn.addEventListener('click', async () => {
          currentPage++;
          const hasMore = await loadMessages(artefactId, upper, currentPage);
          if (!hasMore) loadMoreBtn.style.display = 'none';
        });

        /* === RECORD === */
audioBtn.addEventListener('click', async () => {

  /* 1) Si l‚Äôenregistreur est inactif ‚Üí on d√©marre */
  if (!recorder || recorder.state === 'inactive') {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      recorder = new MediaRecorder(stream);
      chunks   = [];

      /* ---------- CHRONOM√àTRE : initialise ---------- */
      startTime       = Date.now();             // m√©morise l‚Äôinstant de d√©part
      timerSpan.textContent = '00:00';          // affiche 0:00
      timerId = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerSpan.textContent = formatTime(elapsed);
        /* option : stop auto apr√®s 300 s
           if (elapsed >= 300) recorder.stop(); */
      }, 1000);
      /* ---------------------------------------------- */

      recorder.ondataavailable = e => chunks.push(e.data);

      recorder.onstop = () => {
        /* ‚Äì‚Äì stop chrono ‚Äì‚Äì */
        clearInterval(timerId);
        timerId    = null;
        startTime  = null;
        timerSpan.textContent = '';             // efface l‚Äôaffichage

        /* ‚Äì‚Äì g√©n√®re l‚Äôaper√ßu ‚Äì‚Äì */
        tempBlob = new Blob(chunks, { type: 'audio/webm' });

        /* ici on v√©rifie la taille max 5 Mo */
        if (tempBlob.size > MAX_AUDIO_BYTES) {
          alert('O √°udio √© muito grande (m√°x. 5 MB). Grave novamente.');
          resetPreview();
          return;
        }

        tempURL  = URL.createObjectURL(tempBlob);
        renderPreview();
        audioBtn.textContent = 'üéôÔ∏è Gravar';     // remet l‚Äôic√¥ne micro
      };

      recorder.start();
      audioBtn.textContent = '‚èπÔ∏è Parar';        // bouton stop

    } catch (err) {
      alert('N√£o foi poss√≠vel acessar o microfone');
    }

  /* 2) Sinon (il enregistre) ‚Üí on stoppe */
  } else if (recorder.state === 'recording') {
    recorder.stop();
  }
});

     
/* === PUBLISH === */
publishBtn.addEventListener('click', async () => {
  // Obtenir la valeur du commentaire
  const comment = textarea.value.trim();
  
  // V√©rification si au moins le commentaire ou l'audio est pr√©sent
  if (!comment && !tempBlob) {
    alert('Adicione um coment√°rio ou grave um √°udio.');
    return;
  }

  if (tempBlob && tempBlob.size > MAX_AUDIO_BYTES) {
    alert('O √°udio √© muito grande (m√°x. 5 MB). Grave novamente.');
    return;
  }

  publishBtn.disabled = true;
  
  try {
    // G√©n√©rer une cl√© secr√®te
    const payload = {
      artefact_id: artefactId,
      author: nameInput.value.trim() || 'An√¥nimo',
      comment,
      audioBase64: tempBlob ? await blobToBase64(tempBlob) : null
    };
    
    const res = await fetch('/.netlify/functions/add-message', {
      method: 'POST', 
      body: JSON.stringify(payload)
    });
    
    const { success, id, delete_token } = await res.json();

    if (success) {
      const userMessages = JSON.parse(localStorage.getItem('userMessages') || '{}');
      userMessages[id] = delete_token;
      localStorage.setItem('userMessages', JSON.stringify(userMessages));
      
      textarea.value = '';
      nameInput.value = '';
      resetPreview();
      
      // Vider le cache pour cet artefact
      Object.keys(messageCache).forEach(key => {
        if (key.startsWith(artefactId)) delete messageCache[key];
      });
      
      currentPage = 0;
      loadMessages(artefactId, upper).then(hasMore => {
        loadMoreBtn.style.display = hasMore ? 'block' : 'none';
      });
    } else { 
      alert('Erro ao publicar'); 
    }
  } catch (error) {
    console.error('Erro ao publicar:', error);
    alert('Erro ao publicar: ' + error.message);
  } finally {
    publishBtn.disabled = false;
  }
});

      // Fonction de chargement d'artefacts
      function loadArtefacts(count = 3) {
        if (isLoading || currentIndex >= images.length) return;
        
        isLoading = true;
        loadingIndicator.style.display = 'block';
        
        const nextImages = images.slice(currentIndex, currentIndex + count);
        currentIndex += count;
        
        setTimeout(() => {
          nextImages.forEach(renderArtefact);
          isLoading = false;
          loadingIndicator.style.display = 'none';
          
          // V√©rifier si nous avons besoin de charger plus d'images
          checkScrollPosition();
        }, 300); // Petit d√©lai pour une meilleure UX
      }

      // Fonction pour v√©rifier la position de d√©filement
      function checkScrollPosition() {
        if (isLoading || currentIndex >= images.length) return;
        
        const scrollPosition = window.innerHeight + window.scrollY;
        const bodyHeight = document.body.offsetHeight;
        
        // Charger plus d'artefacts si on approche du bas de la page
        if (scrollPosition > bodyHeight - 500) {
          loadArtefacts();
        }
      }

      // √âcouteur d'√©v√©nement pour le d√©filement
      window.addEventListener('scroll', checkScrollPosition);
      
      // Charger les premiers artefacts
      loadArtefacts();
    </script>
  </body>
</html>
